---
title: "An Analysis of the Effectiveness of Vaccination Encouragements using the Interrupted Time Series (ITS)"
author: "Corey Jackson"
date: "`r Sys.time()`"
output:
  html_document:
    fig_caption: yes
    highlight: pygments
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_float:
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '5'
always_allow_html: yes
editor_options: 
  chunk_output_type: console
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "asis")
```

```{r packages, include = FALSE}
# packages
library(dplyr)
library(grDevices)
library(kableExtra)
library(leaflet)
library(lubridate)
library(pander)
panderOptions('knitr.auto.asis', FALSE)
panderOptions('table.split.table', Inf)
library(scales)        # variable transforms, formatting tables
library(stargazer)     # formatting regression output
library(tibble)
library(tidyverse)
library(trend)
library("ggsci")
library("ggplot2")
library(gridExtra)
#library(Wats)          # time series plots
library(hrbrthemes)
library(scales)
```

``` {r, include = FALSE}
###### load/clean encouragement data ###### 
incentives <- read_csv("/Volumes/cbjackson2/fira/data/incentives/Encouragement-Strategies-FINAL-06082022.csv") # loads data
#incentives <- read_csv("./Encouragement-Strategies-FINAL-06082022.csv") # loads data
incentives_original <- incentives
# subset for now
incentives <- incentives[which(!is.na(incentives$dose1)),]
# fix dates
incentives <- incentives %>%
  mutate(start = lubridate::dmy(dose1)) %>%
  drop_na(start) %>%
  select(id = record_id, name = name_given, census_tract = "Full FIPS (tract)", start,  target_age, target_racethgroup, target_gender) 
incentives <- incentives[order(incentives$id), ]
  
####### load/clean vaccination data #######
# import total, age, gender, race/eth, and tract vaccination rates
tract_trend <- read_csv("/Volumes/cbjackson2/fira/data/vaccination/vaccination_day_tract.csv") # loads data
#tract_trend <- read_csv("./vaccination_day_tract.csv") # loads data
tract_trend <- tract_trend %>%
  filter(population > 0) %>%
  mutate(date = lubridate::ymd(date)) 
```

# Project summary

__Phase 1A__     
  - Date: December 14, 2020    
  - Estimated population: 550,000 [Source: [DHS](https://www.dhs.wisconsin.gov/news/releases/011121.htm)]    
  - 1A Population    
      - Front line health care workers and residents of long term care facilities including nursing homes and assisted living facilities.    

__Phase 1B__     
  - Date: March 1 2021    
  - Estimated Population: 1.6 million people [Source: [SDMAC vaccine subcommittee](https://spectrumnews1.com/wi/milwaukee/news/2021/01/21/older-adults-and-1b--who-s-next-in-wisconsin-s-covid-19-vaccine-line-)]]    
      - Frontline health care personnel    
      - Residents of long-term care    
      - Police and fire personnel, correctional staff    
      - Adults age 65 and older    
      - Education and child care staff    
      - Individuals enrolled in Medicaid long-term care programs    
      - Some public-facing essential workers such as 911 operators, public transit, and grocery store employees    
      - Non-frontline essential health care personnel    
      - Facility staff and residents of congregate living settings    


*Research questions:* Does a vaccination encouragement intervention affect vaccination rates? 

# Methods


## A function to build ITS models for each encouragement

```{r}
# create a function that builds a ITS model for an encouragement, given fips and the start date
ITS_model <- function(id, tract, interruption_date, age, race, gender, name) {
 
  interruption_date <- as.Date(interruption_date)
  
  # filter the data according to the fips
  vaccinations_tract <- tract_trend %>%
    filter(as.character(Census_Tract) == as.character(tract)) %>%
    drop_na(vaccinations_day) %>%
    filter(vaccinations_day >= 0)
  
  # check if there is vaccination data of the tract
  if (nrow(vaccinations_tract) == 0) {
    return (FALSE)
  }
  
  # check if there is vaccination data at the time of the encouragement
  if (interruption_date > max(vaccinations_tract$date)) {
    return (FALSE)                           
  }
  
  vaccinations_tract <- vaccinations_tract %>%
    mutate(Time = as.integer(date - min(vaccinations_tract$date)))
  
  vaccinations_tract <- vaccinations_tract[order(vaccinations_tract$Time), ]
  
  first_day <- min(vaccinations_tract$date)
  
  # target age ("18to65", "under18", "under18, 18to65", "18to65, under18")
  if (grepl("18to65", age)) {
    # get the time series
    TS_data <- vaccinations_tract %>%
      mutate(Treatment = ifelse(date < interruption_date, 0, 1), 
             Time_since = ifelse(Treatment == 0, 0, as.integer(date - interruption_date))) %>%
      select(vaccinations_18to65, date, Time, Treatment, Time_since) 
  
    interruption_index <- max(which(TS_data$Time_since == 0))
    # show the time series in a scatter plot (only 14 days before / after the interruption) # CHANGED
    
    TS_data_new <- TS_data[max(1, (interruption_index - 7)) : min((interruption_index + 6),    nrow(TS_data)), ] # change this date range   
      
    TS_data_new <- mutate(TS_data_new, period = ifelse(Treatment == 0, "Pre", "Post"))
    TS_data_new2 <- data.frame(TS_data_new)
    #print(TS_data_new)  
    #str(TS_data_new)    
    
    #### CODE WORKS
    p1 <- ggplot(TS_data_new2, aes(x = date, y = vaccinations_18to65, group = period)) + 
      geom_point()  + 
      ggtitle(paste("Effect of the", name, "encouragement (18 to 65)")) +
      labs(x = "Date", y  = "Daily Vaccinations (18 to 65)") + 
      geom_smooth(method = "lm", color = "#0072B5FF", se = TRUE) +
      geom_vline(xintercept = as.numeric(TS_data_new2$date[min(which(TS_data_new2$period == "Post"))]), linetype = 'dashed', col = "red") +
      theme_ipsum() +
      scale_fill_nejm() +
      theme(plot.margin = unit(c(.1,.1,.1,.1), "cm"))
        print(p1)
    

    #### CODE WORKS

    # add the regression line
    TS_model <- lm(vaccinations_18to65 ~ Time + Treatment + Time_since, data = TS_data_new)
    #lines(TS_data_new$date, TS_model$fitted.values, col = "steelblue", lwd = 2 )
    summary(TS_model)
  
    # get the ITS model
    stargazer(TS_model, type = "html", dep.var.labels = ("Daily Vaccinations (18 to 65)"), 
           column.labels = ("Model results"), 
           covariate.labels = c("Time", "Encouragement", "Time Since Encouragement"),
           omit.stat = "all", digits = 2)
  
    # look at the trend only during the 2 weeks
      during_encouragment <- TS_data[max(1, (interruption_index)) : min(nrow(TS_data), (interruption_index + 7)),] # CHANGED
      p2 <- ggplot(during_encouragment, aes(x = date, y = vaccinations_18to65)) +
        labs(x = "Date", y = "Daily Vaccinations (18 to 65)") + 
        ggtitle(paste("Daily Vaccinations Trend during the Encouragment (18 to 65)")) +
        geom_point() +
        geom_smooth(method = "lm", col = "gray", se = TRUE)
      print(p2)
  
    model <- summary(TS_model)
    if (length(model) == 0) {
      next
    } else if (length(model$coef[,1]) < 4) {
      next
    } else {
      p_val <- pf(model$fstatistic[1], model$fstatistic[2], model$fstatistic[3], lower.tail = FALSE)
      actual_0 <- TS_data$vaccinations_18to65[min(which(TS_data$Treatment == 1))]
      actual_3 <- TS_data$vaccinations_18to65[which(TS_data$Time_since == 3)]
      actual_5 <- TS_data$vaccinations_18to65[which(TS_data$Time_since == 5)]
      counterfactual_0 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[min(which(TS_data$Treatment == 1))]
      counterfactual_3 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 3)]
      counterfactual_5 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 5)]
      
      all_models <<- add_row(all_models, "ID" = as.integer(id), 
                             "Encouragement" = as.character(name), "Group" = "18 to 65",
                             "Intercept" = model$coef[1,1], "P-value (Intercept)" = model$coef[1,4],
                             "Time" = model$coef[2,1], "P-value (Time)" = model$coef[2,4],
                             "Treatment" = model$coef[3,1], "P-value (Treatment)" = model$coef[3,4],
                             "Time Since" = model$coef[4,1], "P-value (Time Since)" = model$coef[4,4],
                             "P-value (Model)" = p_val,
                             "Actual (Day 0)" = actual_0,
                             "Counterfactual (Day 0)" = counterfactual_0, 
                             "Difference (Day 0)" = actual_0 - counterfactual_0, 
                             "Actual (Day 3)" = actual_3,
                             "Counterfactual (Day 3)" = counterfactual_3, 
                             "Difference (Day 3)" = actual_0 - counterfactual_3, 
                             "Actual (Day 5)" =  actual_5, 
                             "Counterfactual (Day 5)" = counterfactual_5, 
                             "Difference (Day 5)" = actual_5 - counterfactual_5)  
      model
    }
  }
  if (grepl("under18", age)) {
   # get the time series
    TS_data <- vaccinations_tract %>%
      mutate(Treatment = ifelse(date < interruption_date, 0, 1), 
             Time_since = ifelse(Treatment == 0, 0, as.integer(date - interruption_date))) %>%
      select(vaccinations_under18, date, Time, Treatment, Time_since) 
  
    interruption_index <- max(which(TS_data$Time_since == 0))
 
    # show the time series in a scatter plot (only 14 days before / after the interruption)
    TS_data_new <- TS_data[max(1, (interruption_index - 7)) : min((interruption_index + 6), nrow(TS_data)), ] # change this date range
    TS_data_new <- mutate(TS_data_new, period = ifelse(Treatment == 0, "Pre", "Post"))
    TS_data_new2 <- data.frame(TS_data_new)
    #print(TS_data_new)  
    #str(TS_data_new)    
    
    #### CODE WORKS
    p1 <- ggplot(TS_data_new2, aes(x = date, y = vaccinations_under18, group = period)) + 
      geom_point()  + 
      ggtitle(paste("Effect of the", name, "encouragement (under 18)")) +
      labs(x = "Date", y  = "Daily Vaccinations (under 18)") + 
      geom_smooth(method = "lm", color = "#0072B5FF", se = TRUE) +
      geom_vline(xintercept = as.numeric(TS_data_new2$date[min(which(TS_data_new2$period == "Post"))]), linetype = 'dashed', col = "red") +
      theme_ipsum() +
      scale_fill_nejm() +
      theme(plot.margin = unit(c(.1,.1,.1,.1), "cm"))
    print(p1)
    #### CODE WORKS

    # add the regression line
    TS_model <- lm(vaccinations_under18 ~ Time + Treatment + Time_since, data = TS_data_new)
    #lines(TS_data_new$date, TS_model$fitted.values, col = "steelblue", lwd = 2 )
    summary(TS_model)
  
    # get the ITS model
    stargazer(TS_model, type = "html", dep.var.labels = ("Daily Vaccinations (Under 18)"), 
           column.labels = ("Model results"), 
           covariate.labels = c("Time", "Encouragement", "Time Since Encouragement"),
           omit.stat = "all", digits = 2)
  
    # look at the trend only during the 2 weeks
      during_encouragment <- TS_data[max(1, (interruption_index)) : min(nrow(TS_data), (interruption_index + 7)),] # CHANGED
      p2 <- ggplot(during_encouragment, aes(x = date, y = vaccinations_under18)) +
        labs(x = "Date", y = "Daily Vaccinations (Under 18)") + 
        ggtitle(paste("Daily Vaccinations Trend during the Encouragment (Under 18)")) +
        geom_point() +
        geom_smooth(method = "lm", col = "gray", se = TRUE)
      print(p2)
  
    model <- summary(TS_model)
    if (length(model) == 0) {
      next
    } else if (length(model$coef[,1]) < 4) {
      next
    } else {
      p_val <- pf(model$fstatistic[1], model$fstatistic[2], model$fstatistic[3], lower.tail = FALSE)
      actual_0 <- TS_data$vaccinations_under18[min(which(TS_data$Treatment == 1))]
      actual_3 <- TS_data$vaccinations_under18[which(TS_data$Time_since == 3)]
      actual_5 <- TS_data$vaccinations_under18[which(TS_data$Time_since == 5)]
      counterfactual_0 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[min(which(TS_data$Treatment == 1))]
      counterfactual_3 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 3)]
      counterfactual_5 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 5)]
      
      all_models <<- add_row(all_models, "ID" = as.integer(id), 
                             "Encouragement" = as.character(name), "Group" = "Under 18",
                             "Intercept" = model$coef[1,1], "P-value (Intercept)" = model$coef[1,4],
                             "Time" = model$coef[2,1], "P-value (Time)" = model$coef[2,4],
                             "Treatment" = model$coef[3,1], "P-value (Treatment)" = model$coef[3,4],
                             "Time Since" = model$coef[4,1], "P-value (Time Since)" = model$coef[4,4],
                             "P-value (Model)" = p_val,
                             "Actual (Day 0)" = actual_0,
                             "Counterfactual (Day 0)" = counterfactual_0, 
                             "Difference (Day 0)" = actual_0 - counterfactual_0, 
                             "Actual (Day 3)" = actual_3,
                             "Counterfactual (Day 3)" = counterfactual_3, 
                             "Difference (Day 3)" = actual_0 - counterfactual_3, 
                             "Actual (Day 5)" =  actual_5, 
                             "Counterfactual (Day 5)" = counterfactual_5, 
                             "Difference (Day 5)" = actual_5 - counterfactual_5)
      model
    }
  } 
  if (grepl("black", race)) {
    # get the time series
    TS_data <- vaccinations_tract %>%
      mutate(Treatment = ifelse(date < interruption_date, 0, 1), 
             Time_since = ifelse(Treatment == 0, 0, as.integer(date - interruption_date))) %>%
      select(vaccinations_black, date, Time, Treatment, Time_since) 
  
    interruption_index <- max(which(TS_data$Time_since == 0))
    # show the time series in a scatter plot (only 14 days before / after the interruption)
    TS_data_new <- TS_data[max(1, (interruption_index - 7)) : min((interruption_index + 6), nrow(TS_data)), ] # change this date range
    TS_data_new <- mutate(TS_data_new, period = ifelse(Treatment == 0, "Pre", "Post"))
    TS_data_new2 <- data.frame(TS_data_new)
    #print(TS_data_new)  
    #str(TS_data_new)    
    
    #### CODE WORKS
    p1 <- ggplot(TS_data_new2, aes(x = date, y = vaccinations_black, group = period)) + 
      geom_point()  + 
      ggtitle(paste("Effect of the", name, "encouragement (Black)")) +
      labs(x = "Date", y  = "Daily Vaccinations (Black)") + 
      geom_smooth(method = "lm", color = "#0072B5FF", se = TRUE) +
      geom_vline(xintercept = as.numeric(TS_data_new2$date[min(which(TS_data_new2$period == "Post"))]), linetype = 'dashed', col = "red") +
      theme_ipsum() +
      scale_fill_nejm() +
      theme(plot.margin = unit(c(.1,.1,.1,.1), "cm"))
    print(p1)
    #### CODE WORKS

    # add the regression line
    TS_model <- lm(vaccinations_black ~ Time + Treatment + Time_since, data = TS_data_new)
    #lines(TS_data_new$date, TS_model$fitted.values, col = "steelblue", lwd = 2 )
    summary(TS_model)
  
    # get the ITS model
    stargazer(TS_model, type = "html", dep.var.labels = ("Daily Vaccinations (Black)"), 
           column.labels = ("Model results"), 
           covariate.labels = c("Time", "Encouragement", "Time Since Encouragement"),
           omit.stat = "all", digits = 2)
  
    # look at the trend only during the 2 weeks
      during_encouragment <- TS_data[max(1, (interruption_index)) : min(nrow(TS_data), (interruption_index + 7)),] # CHANGED
      p2 <- ggplot(during_encouragment, aes(x = date, y = vaccinations_black)) +
        labs(x = "Date", y = "Daily Vaccinations (Black)") + 
        ggtitle(paste("Daily Vaccinations Trend during the Encouragment (Black)")) +
        geom_point() +
        geom_smooth(method = "lm", col = "gray", se = TRUE)
      print(p2)
    
    model <- summary(TS_model)
    if (length(model) == 0) {
      next
    } else if (length(model$coef[,1]) < 4) {
      next
    } else {
      p_val <- pf(model$fstatistic[1], model$fstatistic[2], model$fstatistic[3], lower.tail = FALSE)
      actual_0 <- TS_data$vaccinations_black[min(which(TS_data$Treatment == 1))]
      actual_3 <- TS_data$vaccinations_black[which(TS_data$Time_since == 3)]
      actual_5 <- TS_data$vaccinations_black[which(TS_data$Time_since == 5)]
      counterfactual_0 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[min(which(TS_data$Treatment == 1))]
      counterfactual_3 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 3)]
      counterfactual_5 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 5)]
      
      all_models <<- add_row(all_models, "ID" = as.integer(id), 
                             "Encouragement" = as.character(name), "Group" = "Black",
                             "Intercept" = model$coef[1,1], "P-value (Intercept)" = model$coef[1,4],
                             "Time" = model$coef[2,1], "P-value (Time)" = model$coef[2,4],
                             "Treatment" = model$coef[3,1], "P-value (Treatment)" = model$coef[3,4],
                             "Time Since" = model$coef[4,1], "P-value (Time Since)" = model$coef[4,4],
                             "P-value (Model)" = p_val,
                             "Actual (Day 0)" = actual_0,
                             "Counterfactual (Day 0)" = counterfactual_0, 
                             "Difference (Day 0)" = actual_0 - counterfactual_0, 
                             "Actual (Day 3)" = actual_3,
                             "Counterfactual (Day 3)" = counterfactual_3, 
                             "Difference (Day 3)" = actual_0 - counterfactual_3, 
                             "Actual (Day 5)" =  actual_5, 
                             "Counterfactual (Day 5)" = counterfactual_5, 
                             "Difference (Day 5)" = actual_5 - counterfactual_5)
      model
    }
  }
  if (grepl("aian", race)) {
    # get the time series
    TS_data <- vaccinations_tract %>%
      mutate(Treatment = ifelse(date < interruption_date, 0, 1), 
             Time_since = ifelse(Treatment == 0, 0, as.integer(date - interruption_date))) %>%
      select(vaccinations_aian, date, Time, Treatment, Time_since) 
  
    interruption_index <- max(which(TS_data$Time_since == 0))
 
    # show the time series in a scatter plot (only 14 days before / after the interruption)
    TS_data_new <- TS_data[max(1, (interruption_index - 7)) : min((interruption_index + 6), nrow(TS_data)), ] # change this date range
    TS_data_new <- mutate(TS_data_new, period = ifelse(Treatment == 0, "Pre", "Post"))
    TS_data_new2 <- data.frame(TS_data_new)
    #print(TS_data_new)  
    #str(TS_data_new)    
    
    #### CODE WORKS
    p1 <- ggplot(TS_data_new2, aes(x = date, y = vaccinations_aian, group = period)) + 
      geom_point()  + 
      ggtitle(paste("Effect of the", name, "encouragement (Aian)")) +
      labs(x = "Date", y  = "Daily Vaccinations (Aian)") + 
      geom_smooth(method = "lm", color = "#0072B5FF", se = TRUE) +
      geom_vline(xintercept = as.numeric(TS_data_new2$date[min(which(TS_data_new2$period == "Post"))]), linetype = 'dashed', col = "red") +
      theme_ipsum() +
      scale_fill_nejm() +
      theme(plot.margin = unit(c(.1,.1,.1,.1), "cm"))
    print(p1)
    #### CODE WORKS

    # add the regression line
    TS_model <- lm(vaccinations_aian ~ Time + Treatment + Time_since, data = TS_data_new)
    #lines(TS_data_new$date, TS_model$fitted.values, col = "steelblue", lwd = 2 )
    summary(TS_model)
  
    # get the ITS model
    stargazer(TS_model, type = "html", dep.var.labels = ("Daily Vaccinations (Aian)"), 
           column.labels = ("Model results"), 
           covariate.labels = c("Time", "Encouragement", "Time Since Encouragement"),
           omit.stat = "all", digits = 2)
  
    # look at the trend only during the 2 weeks
      during_encouragment <- TS_data[max(1, (interruption_index)) : min(nrow(TS_data), (interruption_index + 7)),] # CHANGED
      p2 <- ggplot(during_encouragment, aes(x = date, y = vaccinations_aian)) +
        labs(x = "Date", y = "Daily Vaccinations (Aian)") + 
        ggtitle(paste("Daily Vaccinations Trend during the Encouragment (Aian)")) +
        geom_point() +
        geom_smooth(method = "lm", col = "gray", se = TRUE)
      print(p2)
    
    model <- summary(TS_model)
    if (length(model) == 0) {
      next
    } else if (length(model$coef[,1]) < 4) {
      next
    } else {
      p_val <- pf(model$fstatistic[1], model$fstatistic[2], model$fstatistic[3], lower.tail = FALSE)
      actual_0 <- TS_data$vaccinations_aian[min(which(TS_data$Treatment == 1))]
      actual_3 <- TS_data$vaccinations_aian[which(TS_data$Time_since == 3)]
      actual_5 <- TS_data$vaccinations_aian[which(TS_data$Time_since == 5)]
      counterfactual_0 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[min(which(TS_data$Treatment == 1))]
      counterfactual_3 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 3)]
      counterfactual_5 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 5)]
      
      all_models <<- add_row(all_models, "ID" = as.integer(id), 
                             "Encouragement" = as.character(name), "Group" = "Aian",
                             "Intercept" = model$coef[1,1], "P-value (Intercept)" = model$coef[1,4],
                             "Time" = model$coef[2,1], "P-value (Time)" = model$coef[2,4],
                             "Treatment" = model$coef[3,1], "P-value (Treatment)" = model$coef[3,4],
                             "Time Since" = model$coef[4,1], "P-value (Time Since)" = model$coef[4,4],
                             "P-value (Model)" = p_val,
                             "Actual (Day 0)" = actual_0,
                             "Counterfactual (Day 0)" = counterfactual_0, 
                             "Difference (Day 0)" = actual_0 - counterfactual_0, 
                             "Actual (Day 3)" = actual_3,
                             "Counterfactual (Day 3)" = counterfactual_3, 
                             "Difference (Day 3)" = actual_0 - counterfactual_3, 
                             "Actual (Day 5)" =  actual_5, 
                             "Counterfactual (Day 5)" = counterfactual_5, 
                             "Difference (Day 5)" = actual_5 - counterfactual_5)
      model
    }
  }
  if (grepl("hispanic", race)) {
    # get the time series
    TS_data <- vaccinations_tract %>%
      mutate(Treatment = ifelse(date < interruption_date, 0, 1), 
             Time_since = ifelse(Treatment == 0, 0, as.integer(date - interruption_date))) %>%
      select(vaccinations_Ehispanic, date, Time, Treatment, Time_since) 
  
    interruption_index <- max(which(TS_data$Time_since == 0))
    
    # show the time series in a scatter plot (only 14 days before / after the interruption)
    TS_data_new <- TS_data[max(1, (interruption_index - 7)) : min((interruption_index + 6), nrow(TS_data)), ] # change this date range
    TS_data_new <- mutate(TS_data_new, period = ifelse(Treatment == 0, "Pre", "Post"))
    TS_data_new2 <- data.frame(TS_data_new)
    #print(TS_data_new)  
    #str(TS_data_new)    
    
    #### CODE WORKS
    p1 <- ggplot(TS_data_new2, aes(x = date, y = vaccinations_Ehispanic, group = period)) + 
      geom_point()  + 
      ggtitle(paste("Effect of the", name, "encouragement (Hispanic)")) +
      labs(x = "Date", y  = "Daily Vaccinations (Hispanic)") + 
      geom_smooth(method = "lm", color = "#0072B5FF", se = TRUE) +
      geom_vline(xintercept = as.numeric(TS_data_new2$date[min(which(TS_data_new2$period == "Post"))]), linetype = 'dashed', col = "red") +
      theme_ipsum() +
      scale_fill_nejm() +
      theme(plot.margin = unit(c(.1,.1,.1,.1), "cm"))
    print(p1)
    #### CODE WORKS

    # add the regression line
    TS_model <- lm(vaccinations_Ehispanic ~ Time + Treatment + Time_since, data = TS_data_new)
    #lines(TS_data_new$date, TS_model$fitted.values, col = "steelblue", lwd = 2 )
    summary(TS_model)
  
    # get the ITS model
    stargazer(TS_model, type = "html", dep.var.labels = ("Daily Vaccinations (Hispanic)"), 
           column.labels = ("Model results"), 
           covariate.labels = c("Time", "Encouragement", "Time Since Encouragement"),
           omit.stat = "all", digits = 2)
  
    # look at the trend only during the 2 weeks
      during_encouragment <- TS_data[max(1, (interruption_index)) : min(nrow(TS_data), (interruption_index + 7)),] # CHANGED
      p2 <- ggplot(during_encouragment, aes(x = date, y = vaccinations_Ehispanic)) +
        labs(x = "Date", y = "Daily Vaccinations (Hispanic)") + 
        ggtitle(paste("Daily Vaccinations Trend during the Encouragment (Hispanic)")) +
        geom_point() +
        geom_smooth(method = "lm", col = "gray", se = TRUE)
      print(p2)
    
    model <- summary(TS_model)
    if (length(model) == 0) {
      next
    } else if (length(model$coef[,1]) < 4) {
      next
    } else {
      p_val <- pf(model$fstatistic[1], model$fstatistic[2], model$fstatistic[3], lower.tail = FALSE)
      actual_0 <- TS_data$vaccinations_Ehispanic[min(which(TS_data$Treatment == 1))]
      actual_3 <- TS_data$vaccinations_Ehispanic[which(TS_data$Time_since == 3)]
      actual_5 <- TS_data$vaccinations_Ehispanic[which(TS_data$Time_since == 5)]
      counterfactual_0 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[min(which(TS_data$Treatment == 1))]
      counterfactual_3 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 3)]
      counterfactual_5 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 5)]
      
      all_models <<- add_row(all_models, "ID" = as.integer(id), 
                             "Encouragement" = as.character(name), "Group" = "Hispanic",
                             "Intercept" = model$coef[1,1], "P-value (Intercept)" = model$coef[1,4],
                             "Time" = model$coef[2,1], "P-value (Time)" = model$coef[2,4],
                             "Treatment" = model$coef[3,1], "P-value (Treatment)" = model$coef[3,4],
                             "Time Since" = model$coef[4,1], "P-value (Time Since)" = model$coef[4,4],
                             "P-value (Model)" = p_val,
                             "Actual (Day 0)" = actual_0,
                             "Counterfactual (Day 0)" = counterfactual_0, 
                             "Difference (Day 0)" = actual_0 - counterfactual_0, 
                             "Actual (Day 3)" = actual_3,
                             "Counterfactual (Day 3)" = counterfactual_3, 
                             "Difference (Day 3)" = actual_0 - counterfactual_3, 
                             "Actual (Day 5)" =  actual_5, 
                             "Counterfactual (Day 5)" = counterfactual_5, 
                             "Difference (Day 5)" = actual_5 - counterfactual_5)
      model
    }
  }
  if (grepl("asian", race)) {
    # get the time series
    TS_data <- vaccinations_tract %>%
      mutate(Treatment = ifelse(date < interruption_date, 0, 1), 
             Time_since = ifelse(Treatment == 0, 0, as.integer(date - interruption_date))) %>%
      select(vaccinations_asian, date, Time, Treatment, Time_since) 
  
    interruption_index <- max(which(TS_data$Time_since == 0))
    # show the time series in a scatter plot (only 14 days before / after the interruption)
    TS_data_new <- TS_data[max(1, (interruption_index - 7)) : min((interruption_index + 6), nrow(TS_data)), ] # change this date range
    TS_data_new <- mutate(TS_data_new, period = ifelse(Treatment == 0, "Pre", "Post"))
    TS_data_new2 <- data.frame(TS_data_new)
    #print(TS_data_new)  
    #str(TS_data_new)    
    
    #### CODE WORKS
    p1 <- ggplot(TS_data_new2, aes(x = date, y = vaccinations_asian, group = period)) + 
      geom_point()  + 
      ggtitle(paste("Effect of the", name, "encouragement (Asian)")) +
      labs(x = "Date", y  = "Daily Vaccinations (Asian)") + 
      geom_smooth(method = "lm", color = "#0072B5FF", se = TRUE) +
      geom_vline(xintercept = as.numeric(TS_data_new2$date[min(which(TS_data_new2$period == "Post"))]), linetype = 'dashed', col = "red") +
      theme_ipsum() +
      scale_fill_nejm() +
      theme(plot.margin = unit(c(.1,.1,.1,.1), "cm"))
    print(p1)
    #### CODE WORKS

    # add the regression line
    TS_model <- lm(vaccinations_asian ~ Time + Treatment + Time_since, data = TS_data_new)
    #lines(TS_data_new$date, TS_model$fitted.values, col = "steelblue", lwd = 2 )
    summary(TS_model)
  
    # get the ITS model
    stargazer(TS_model, type = "html", dep.var.labels = ("Daily Vaccinations (Asian)"), 
           column.labels = ("Model results"), 
           covariate.labels = c("Time", "Encouragement", "Time Since Encouragement"),
           omit.stat = "all", digits = 2)
  
    # look at the trend only during the 2 weeks
      during_encouragment <- TS_data[max(1, (interruption_index)) : min(nrow(TS_data), (interruption_index + 7)),] # CHANGED
      p2 <- ggplot(during_encouragment, aes(x = date, y = vaccinations_asian)) +
        labs(x = "Date", y = "Daily Vaccinations (Asian)") + 
        ggtitle(paste("Daily Vaccinations Trend during the Encouragment (Asian)")) +
        geom_point() +
        geom_smooth(method = "lm", col = "gray", se = TRUE)
      print(p2)
    
    model <- summary(TS_model)
    if (length(model) == 0) {
      next
    } else if (length(model$coef[,1]) < 4) {
      next
    } else {      
      p_val <- pf(model$fstatistic[1], model$fstatistic[2], model$fstatistic[3], lower.tail = FALSE)
      actual_0 <- TS_data$vaccinations_asian[min(which(TS_data$Treatment == 1))]
      actual_3 <- TS_data$vaccinations_asian[which(TS_data$Time_since == 3)]
      actual_5 <- TS_data$vaccinations_asian[which(TS_data$Time_since == 5)]
      counterfactual_0 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[min(which(TS_data$Treatment == 1))]
      counterfactual_3 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 3)]
      counterfactual_5 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 5)]
      
      all_models <<- add_row(all_models, "ID" = as.integer(id), 
                             "Encouragement" = as.character(name), "Group" = "Asian",
                             "Intercept" = model$coef[1,1], "P-value (Intercept)" = model$coef[1,4],
                             "Time" = model$coef[2,1], "P-value (Time)" = model$coef[2,4],
                             "Treatment" = model$coef[3,1], "P-value (Treatment)" = model$coef[3,4],
                             "Time Since" = model$coef[4,1], "P-value (Time Since)" = model$coef[4,4],
                             "P-value (Model)" = p_val,
                             "Actual (Day 0)" = actual_0,
                             "Counterfactual (Day 0)" = counterfactual_0, 
                             "Difference (Day 0)" = actual_0 - counterfactual_0, 
                             "Actual (Day 3)" = actual_3,
                             "Counterfactual (Day 3)" = counterfactual_3, 
                             "Difference (Day 3)" = actual_0 - counterfactual_3, 
                             "Actual (Day 5)" =  actual_5, 
                             "Counterfactual (Day 5)" = counterfactual_5, 
                             "Difference (Day 5)" = actual_5 - counterfactual_5)
      model
    } 
  }
# the whole population
  # get the time series
    TS_data <- vaccinations_tract %>%
      mutate(Treatment = ifelse(date < interruption_date, 0, 1), 
             Time_since = ifelse(Treatment == 0, 0, as.integer(date - interruption_date))) %>%
      select(vaccinations_day, date, Time, Treatment, Time_since) 
  
    interruption_index <- max(which(TS_data$Time_since == 0))
    # show the time series in a scatter plot (only 14 days before / after the interruption)
    TS_data_new <- TS_data[max(1, (interruption_index - 7)) : min((interruption_index + 6), nrow(TS_data)), ] # change this date range
    TS_data_new <- mutate(TS_data_new, period = ifelse(Treatment == 0, "Pre", "Post"))
    TS_data_new2 <- data.frame(TS_data_new)
    #print(TS_data_new)  
    #str(TS_data_new)    
    
    #### CODE WORKS
    p1 <- ggplot(TS_data_new2, aes(x = date, y = vaccinations_day, group = period)) + 
      geom_point()  + 
      ggtitle(paste("Effect of the", name, "encouragement (All)")) +
      labs(x = "Date", y  = "Daily Vaccinations (All)") + 
      geom_smooth(method = "lm", color = "#0072B5FF", se = TRUE) +
      geom_vline(xintercept = as.numeric(TS_data_new2$date[min(which(TS_data_new2$period == "Post"))]), linetype = 'dashed', col = "red") +
      theme_ipsum() +
      scale_fill_nejm() +
      theme(plot.margin = unit(c(.1,.1,.1,.1), "cm"))
    print(p1)
    #### CODE WORKS

    # add the regression line
    TS_model <- lm(vaccinations_day ~ Time + Treatment + Time_since, data = TS_data_new)
    #lines(TS_data_new$date, TS_model$fitted.values, col = "steelblue", lwd = 2 )
    summary(TS_model)
  
    # get the ITS model
    stargazer(TS_model, type = "html", dep.var.labels = ("Daily Vaccinations (All)"), 
           column.labels = ("Model results"), 
           covariate.labels = c("Time", "Encouragement", "Time Since Encouragement"),
           omit.stat = "all", digits = 2)
  
    # look at the trend only during the 2 weeks
      during_encouragment <- TS_data[max(1, (interruption_index)) : min(nrow(TS_data), (interruption_index + 7)),] # CHANGED
      p2 <- ggplot(during_encouragment, aes(x = date, y = vaccinations_day)) +
        labs(x = "Date", y = "Daily Vaccinations (All)") + 
        ggtitle(paste("Daily Vaccinations Trend during the Encouragment (All)")) +
        geom_point() +
        geom_smooth(method = "lm", col = "gray", se = TRUE)
      print(p2)
    
    model <- summary(TS_model)
    if (length(model) == 0) {
      next
    } else if (length(model$coef[,1]) < 4) {
      next
    } else {
      p_val <- pf(model$fstatistic[1], model$fstatistic[2], model$fstatistic[3], lower.tail = FALSE)
      actual_0 <- TS_data$vaccinations_day[min(which(TS_data$Treatment == 1))]
      actual_3 <- TS_data$vaccinations_day[which(TS_data$Time_since == 3)]
      actual_5 <- TS_data$vaccinations_day[which(TS_data$Time_since == 5)]
      counterfactual_0 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[min(which(TS_data$Treatment == 1))]
      counterfactual_3 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 3)]
      counterfactual_5 <- model$coef[1,1] + model$coef[2,1] * TS_data$Time[which(TS_data$Time_since == 5)]
      
      all_models <<- add_row(all_models, "ID" = as.integer(id), 
                             "Encouragement" = as.character(name), "Group" = "All",
                             "Intercept" = model$coef[1,1], "P-value (Intercept)" = model$coef[1,4],
                             "Time" = model$coef[2,1], "P-value (Time)" = model$coef[2,4],
                             "Treatment" = model$coef[3,1], "P-value (Treatment)" = model$coef[3,4],
                             "Time Since" = model$coef[4,1], "P-value (Time Since)" = model$coef[4,4],
                             "P-value (Model)" = p_val,
                             "Actual (Day 0)" = actual_0,
                             "Counterfactual (Day 0)" = counterfactual_0, 
                             "Difference (Day 0)" = actual_0 - counterfactual_0, 
                             "Actual (Day 3)" = actual_3,
                             "Counterfactual (Day 3)" = counterfactual_3, 
                             "Difference (Day 3)" = actual_0 - counterfactual_3, 
                             "Actual (Day 5)" =  actual_5, 
                             "Counterfactual (Day 5)" = counterfactual_5, 
                             "Difference (Day 5)" = actual_5 - counterfactual_5)
      model
    } 
  }
```

## Dataset

__Encouragements__:  

Data obtained from research on vaccination encouragements in Wisconsin. 

__Vaccinations__:  

Data obtained from [Wisconsin Electronic Disease Surveillance System (WEDSS)](https://www.dhs.wisconsin.gov/wiphin/wedss.htm)

__Time series for ITS__:

## Interrupted Time-Series (ITS)

ITS can be used when: 

  1. we have data about an outcome over time (longitudinal data) AND
  2. we want to understand how and if the outcome has changed asfter and intervention that was implemented for the full population at one specific time

We experimented with a 3-day average trend. 

### The Statistical Model 

Y is the outcome
T is a continuious variable indicating the time in days passed from the start of the observational period;
D is a dummy variable indicating observation collected before (=0) and after (=1) the policy intervention;
P is a continuious variable indicated time passed since the intervention has occurred. 

An example of our data appear below 

+--------+----------+---------------+------------------+
|  Y     |  Time (T)| Treatment (D) | Time since (P)   |
+========+==========+===============+==================+
| 10     | 1        | 0             | 0                | 
+--------+----------+---------------+------------------+
| 14     | 2        | 0             | 0                | 
+--------+----------+---------------+------------------+
| 15     | 3        | 0             | 0                | 
+--------+----------+---------------+------------------+
| 16     | 4        | 0             | 0                | 
+--------+----------+---------------+------------------+
| 25     | 5        | 1             | 1                | 
+--------+----------+---------------+------------------+
| 35     | 6        | 1             | 2                | 
+--------+----------+---------------+------------------+
| 37     | 7        | 1             | 3                | 
+--------+----------+---------------+------------------+
| 40     | 8        | 1             | 4                | 
+--------+----------+---------------+------------------+


### Constraints

# Results

```{r}
# Report the analysis for our ITS here
all_models <- tibble("ID" = numeric(), "Encouragement" = character(), "Group" = character(), "Intercept" = numeric(), "P-value (Intercept)" = numeric(), "Time" = numeric(), "P-value (Time)" = numeric(), "Treatment" = numeric(), "P-value (Treatment)" = numeric(), "Time Since" = numeric(), "P-value (Time Since)" = numeric(), "P-value (Model)" = numeric(), "Actual (Day 0)" = numeric(), "Counterfactual (Day 0)" = numeric(), "Difference (Day 0)" = numeric(), "Actual (Day 3)" = numeric(), "Counterfactual (Day 3)" = numeric(), "Difference (Day 3)" = numeric(), "Actual (Day 5)" = numeric(), "Counterfactual (Day 5)" = numeric(), "Difference (Day 5)" = numeric())

for (row in 1:nrow(incentives)) {
  id <- incentives[row, "id"]
  tract <- incentives[row, "census_tract"]
  age <- incentives[row, "target_age"]
  race <- incentives[row, "target_racethgroup"]
  gender <- incentives[row, "target_gender"]
  start_date <- as.data.frame(incentives[row, "start"])[1, 1]
  name <- incentives[row, "name"]
  cat(paste("\nEncouragement:", name, "\n"))
  cat(paste("\n   ID: ", id, "\n"))
  cat(paste("\n   Location (Census Tract): ", tract, "\n"))
  cat(paste("\n   Target age group(s): ", age, "\n"))
  cat(paste("\n   Target race group(s): ", race, "\n"))
  cat(paste("\n   Target gender(s): ", gender, "\n"))
  cat(paste("\n   Start date:", start_date, "\n"))
  cat("\n")
  if (typeof(ITS_model(id, tract, start_date, age, race, gender, name)) == "logical") {
    next
  }
  cat("\n")
}
```

```{r}
write_csv(all_models, file = "./summary.csv", na = "NA", append = FALSE)
```